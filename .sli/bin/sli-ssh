#!/usr/bin/env bash

set -o nounset
set -o errexit

user=$(whoami)
name=
layout="tiled"

while getopts ':u:n:l:h' opt; do
    case $opt in
	u) user=$OPTARG ;;
	n) name=$OPTARG ;;
	l) layout=$OPTARG ;;
	*) echo "Usage: $0 -u user -n name -l layout host..." >&2 && exit 1 ;;
    esac
done

shift $((OPTIND-1))

win=
cmd=
for host in "$@"; do
    if [[ -z "$win" ]]; then
	cmd="new-window"
    else
	cmd="split-window"
    fi
    win=$(tmux "$cmd" -P ssh "$user@$host")
    tmux select-layout -t "$win" "$layout"
    tmux select-pane -t "$win" -T "$host" || true # -T requires tmux 2.6
done

tmux rename-window -t "$win" "$name"
tmux set-option -t "$win" allow-rename off
tmux set-option -t "$win" synchronize-panes on
