#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail
set -o xtrace

if [[ $UID == 0 ]]; then
  echo "don't run as root" 1>&2
  exit 1
fi

setup_packages() {
  packages=(

    # For building git-credential-libsecret
    libglib2.0-dev
    libsecret-1-dev

    build-essential
    curl
    tmux
    zsh
    vim
    emacs-nox
    shellcheck
    source-highlight
    maven
    openjdk-8-jdk
    openjdk-8-source
    openjdk-11-jdk
    openjdk-11-source
  )

  sudo apt install -y "${packages[@]}"
}

setup_git() {
  if [[ ! -f /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret ]]; then
    sudo make --directory=/usr/share/doc/git/contrib/credential/libsecret
  fi
}

setup_shfmt() {
  local tmp=
  local version=3.1.2
  local sha256=c5794c1ac081f0028d60317454fe388068ab5af7740a83e393515170a7157dce
  [[ $(shfmt --version 2>&1) == "v$version" ]] && return

  tmp=$(mktemp)
  trap "{ rm -f $tmp; }" EXIT
  curl -L -o "$tmp" "https://github.com/mvdan/sh/releases/download/v${version}/shfmt_v${version}_linux_amd64"
  sha256sum -c <<<"$sha256 $tmp"
  chmod +x "$tmp"
  mv "$tmp" ~/.local/bin/shfmt
}

setup_shell() {
  local shell=/usr/bin/zsh
  if ! getent passwd "$USER" | grep "$shell"; then
    chsh -s /usr/bin/zsh
  fi
}

setup_packages
setup_git
setup_shfmt
setup_shell
